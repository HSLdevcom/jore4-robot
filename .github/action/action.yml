name: "E2E tests"
description: "Builds test environment and runs e2e tests"
inputs:
  GITHUB_REF_SLUG:
    description: ref_slug
    required: true
  front_end_version:
    description: "version of ui to use"
    required: true
    default: "latest"

runs:
  using: "composite"
  steps:
    # note that we don't checkout code in this job!
    - name: Setup e2e cluster with the remote script
      run: "curl https://raw.githubusercontent.com/HSLdevcom/jore4-flux/${{ inputs.GITHUB_REF_SLUG }}/setupcluster.sh | bash"
      shell: bash

    - name: Verify that application is up and running
      run: |
        for i in {1..20}; do
          curl --fail http://localhost:8000 --output /dev/null --silent && break
          sleep 5
          echo $i
        done
      shell: bash

    - name: Run Robot tests in started environment
      run: |
        docker run --name "robot-tests"\
          hsldevcom/jore4-robot:latest \
            bash -c "robot -v ENV:localhost -v BROWSER:chromium --outputdir /tests/output /tests"
      shell: bash
